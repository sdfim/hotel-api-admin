AWSTemplateFormatVersion: '2010-09-09'
Description: Cloudformation template to create TerraMare resources
Conditions:
  HasAdminPanelUrl: !Not [!Equals [!Ref AppUrlAdminPanel, '']]
  HasContentApiUrl: !Not [!Equals [!Ref AppUrlContentApi, '']]
  HasPricingApiUrl: !Not [!Equals [!Ref AppUrlPricingApi, '']]
Outputs:
  BookingAdminUrl:
    Export:
      Name: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - BookingAdminUrl
    Value: !GetAtt 'AppRunnerBookingAdminApiSvc.ServiceUrl'
  ClientApiUrl:
    Export:
      Name: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - ClientApiUrl
    Value: !GetAtt 'AppRunnerClientApiSvc.ServiceUrl'
  CodePipelineRoleArn:
    Export:
      Name: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - CodePipelineRoleArn
    Value: !GetAtt 'CodePipelineFrontendRole.Arn'
  PricingApiUrl:
    Export:
      Name: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - PricingApiUrl
    Value: !GetAtt 'AppRunnerPricingApiSvc.ServiceUrl'
  S3CodePipelineBucket:
    Export:
      Name: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - S3CodePipelineBucket
    Value: !Ref 'S3CodePipelineBucket'
Parameters:
  APPNAME:
    Default: 'fora-stage'
    Description: Name of the app, it is used to construct resources names
    Type: String
  AppUrlPricingApi:
    Default: ''
    Description: URL for the Booking/Pricing API
    Type: String
  AppUrlContentApi:
    Default: ''
    Description: URL for the Content API
    Type: String
  AppUrlAdminPanel:
    Default: ''
    Description: URL for the Admin Panel
    Type: String
  DockerHubPassword:
    Description: DockerHub password for pulling base images
    Type: String
  DockerHubUsername:
    Description: DockerHub username for pulling base images
    Type: String
  EC2TasksInstanceType:
    Default: t3.small
    Description: Instance type for Tasks ec2 instance
    Type: String
  GhConnectionArn:
    Description: ARN of the connection to GitHub (https://docs.aws.amazon.com/dtconsole/latest/userguide/connections-create-github.html)
    Type: String
  GitHubBackendBranch:
    Default: 'dev'
    Description: Backend (api) branch name that will trigger the pipeline (e.g. main, dev)
    Type: String
  GitHubBackendRepo:
    Default: 'sdfim/fora'
    Description: Backend GitHub repository in format user/repo-name or organization-name/repo-name
    Type: String
  RabbitMqEngineVer:
    Default: 3.13 # Corrected RabbitMQ version
    Description: Engine version for RabbitMQ
    Type: String
  RdsDbAllocatedStorage:
    ConstraintDescription: must be between 5 and 1024Gb.
    Default: '80'
    Description: The size of the database (Gb)
    MaxValue: '1024'
    MinValue: '5'
    Type: Number
  RdsDbClass:
    AllowedValues:
      - db.m5.large
      - db.m5.xlarge
      - db.m5.2xlarge
      - db.m5.4xlarge
      - db.m5.12xlarge
      - db.m5.24xlarge
      - db.m4.large
      - db.m4.xlarge
      - db.m4.2xlarge
      - db.m4.4xlarge
      - db.m4.10xlarge
      - db.m4.16xlarge
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r4.8xlarge
      - db.r4.16xlarge
      - db.x1e.xlarge
      - db.x1e.2xlarge
      - db.x1e.4xlarge
      - db.x1e.8xlarge
      - db.x1e.16xlarge
      - db.x1e.32xlarge
      - db.x1.16xlarge
      - db.x1.32xlarge
      - db.r3.large
      - db.r3.xlarge
      - db.r3.2xlarge
      - db.r3.4xlarge
      - db.r3.8xlarge
      - db.t2.micro
      - db.t2.small
      - db.t2.medium
      - db.t2.large
      - db.t2.xlarge
      - db.t2.2xlarge
      - db.t3.micro # Added compatible t3 instance type
      - db.t3.small
      - db.t3.medium
      - db.t3.large
    ConstraintDescription: must select a valid database instance type.
    Default: db.t3.medium
    Description: Database instance class
    Type: String
  VPCCIDR:
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
    Default: 10.10.0.0/16
    Description: IP Address range for the VPC
    MaxLength: '18'
    MinLength: '9'
    Type: String
  DbDatabase:
    Default: fora_stage_engine
    Description: Mysql database name (DB_DATABASE)
    Type: String
  DbSupplierContentDatabase:
    Default: fora_stage_supplier_content
    Description: Second mysql database name (SUPPLIER_CONTENT_DB_DATABASE)
    Type: String
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64'
Resources:
  AppRunerSecurityGroup:
    DeletionPolicy: Delete
    Properties:
      GroupDescription: App runner SG
      GroupName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - apprunner-sg
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  AppRunnerAutoScalingConf:
    DeletionPolicy: Delete
    Properties:
      AutoScalingConfigurationName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - autoscale-config
      MaxConcurrency: '100'
      MaxSize: '2'
      MinSize: '1'
    Type: AWS::AppRunner::AutoScalingConfiguration
  AppRunnerBookingAdminApiSvc:
    DeletionPolicy: Delete
    Properties:
      AutoScalingConfigurationArn: !GetAtt 'AppRunnerAutoScalingConf.AutoScalingConfigurationArn'
      InstanceConfiguration:
        Cpu: 1 vCPU
        InstanceRoleArn: !GetAtt 'AppRunnerInstanceRole.Arn'
        Memory: 2 GB
      NetworkConfiguration:
        EgressConfiguration:
          EgressType: VPC
          VpcConnectorArn: !GetAtt 'AppRunnerVpcConnector.VpcConnectorArn'
        IngressConfiguration:
          IsPubliclyAccessible: true
      ServiceName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - booking-admin-api
      SourceConfiguration:
        AuthenticationConfiguration:
          AccessRoleArn: !GetAtt 'AppRunnerEcrRole.Arn'
        AutoDeploymentsEnabled: false
        ImageRepository:
          ImageConfiguration:
            Port: '80'
            RuntimeEnvironmentVariables:
              - Name: APP_URL
                Value: !If
                  - HasAdminPanelUrl
                  - !Ref 'AppUrlAdminPanel'
                  - !GetAtt 'AppRunnerBookingAdminApiSvc.ServiceUrl'
              - Name: AWS_BUCKET
                Value: 'fora-stage-storage-bucket'
              - Name: BOOKING_SUPPLIER_HBSI_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_USERNAME}}'
              - Name: BOOKING_SUPPLIER_HBSI_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_PASSWORD}}'
              - Name: BOOKING_SUPPLIER_HBSI_CHANNEL_IDENTIFIER_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_CHANNEL_IDENTIFIER_ID}}'
              - Name: BOOKING_SUPPLIER_HBSI_SEARCH_BOOK_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_SEARCH_BOOK_URL}}'
              - Name: BOOKING_SUPPLIER_HBSI_TARGET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_TARGET}}'
              - Name: BOOKING_SUPPLIER_HBSI_COMPONENT_INFO_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_COMPONENT_INFO_ID}}'
              - Name: CACHE_DRIVER
                Value: 'file'
              - Name: CACHE_STORE
                Value: 'redis'
              - Name: SUPPLIER_EXPEDIA_API_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_API_KEY}}'
              - Name: SUPPLIER_EXPEDIA_SHARED_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_SHARED_SECRET}}'
              - Name: SUPPLIER_EXPEDIA_BASE_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_BASE_URL}}'
              - Name: SUPPLIER_ICE_PORTAL_CLIENT_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_CLIENT_ID}}'
              - Name: SUPPLIER_ICE_PORTAL_CLIENT_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_CLIENT_SECRET}}'
              - Name: SUPPLIER_ICE_PORTAL_BASE_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_BASE_URL}}'
              - Name: SUPPLIER_ICE_PORTAL_TOKEN_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_TOKEN_URL}}'
              - Name: GIATA_POI_BASE_URI
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_BASE_URI}}'
              - Name: GIATA_POI_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_USERNAME}}'
              - Name: GIATA_POI_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_PASSWORD}}'
              - Name: GIATA_MAIN_BASE_URI
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_BASE_URI}}'
              - Name: GIATA_MAIN_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_USERNAME}}'
              - Name: GIATA_MAIN_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_PASSWORD}}'
              - Name: HILTON_CLIENT_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:HILTON_CLIENT_ID}}'
              - Name: HILTON_CLIENT_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:HILTON_CLIENT_SECRET}}'
              - Name: GOOGLE_API_DEVELOPER_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GOOGLE_API_DEVELOPER_KEY}}'
              - Name: LOG_AWS_CLOUDWATCH_ACCESS_KEY_ID # Updated to snake_case
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:LOG_AWS_CLOUDWATCH_ACCESS_KEY_ID}}'
              - Name: LOG_AWS_CLOUDWATCH_SECRET_ACCESS_KEY # Updated to snake_case
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:LOG_AWS_CLOUDWATCH_SECRET_ACCESS_KEY}}'
              - Name: LOG_CHANNEL
                Value: 'daily'
              - Name: DB_CONNECTION
                Value: 'mysql'
              - Name: DB_DATABASE
                Value: !Ref 'DbDatabase'
              - Name: DB_HOST
                Value: !GetAtt 'RdsMysql.Endpoint.Address'
              - Name: DB_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:password}}
              - Name: DB_PORT
                Value: '3306'
              - Name: DB_USERNAME
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:username}}
              - Name: RABBITMQ_HOST
                Value: !Join
                  - ''
                  - !Split
                    - :5671
                    - !Join
                      - ''
                      - !Split
                        - amqps://
                        - !Select
                          - 0
                          - !GetAtt 'RabbitMqBroker.AmqpEndpoints'
              - Name: RABBITMQ_LOGIN
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretMqCreds'
                    - :SecretString:username}}
              - Name: RABBITMQ_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretMqCreds'
                    - :SecretString:password}}
              - Name: RABBITMQ_PORT
                Value: '5671'
              - Name: REDIS_HOST
                Value: !GetAtt 'RedisCache.RedisEndpoint.Address'
              - Name: SUPPLIER_CONTENT_DB_DATABASE
                Value: !Ref 'DbSupplierContentDatabase'
              - Name: SUPPLIER_CONTENT_DB_HOST
                Value: !GetAtt 'RdsMysql.Endpoint.Address'
              - Name: SUPPLIER_CONTENT_DB_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:password}}
              - Name: SUPPLIER_CONTENT_DB_PORT
                Value: '3306'
              - Name: SUPPLIER_CONTENT_DB_USERNAME
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:username}}
              - Name: FILESYSTEM_DISK
                Value: s3
              - Name: PORT
                Value: '80'
          ImageIdentifier: !Join
            - ''
            - - !Ref 'AWS::AccountId'
              - .dkr.ecr.
              - !Ref 'AWS::Region'
              - .amazonaws.com/
              - !Ref 'APPNAME'
              - -api:latest
          ImageRepositoryType: ECR
    Type: AWS::AppRunner::Service
  AppRunnerClientApiSvc:
    DeletionPolicy: Delete
    Properties:
      AutoScalingConfigurationArn: !GetAtt 'AppRunnerAutoScalingConf.AutoScalingConfigurationArn'
      InstanceConfiguration:
        Cpu: 1 vCPU
        InstanceRoleArn: !GetAtt 'AppRunnerInstanceRole.Arn'
        Memory: 2 GB
      NetworkConfiguration:
        EgressConfiguration:
          EgressType: VPC
          VpcConnectorArn: !GetAtt 'AppRunnerVpcConnector.VpcConnectorArn'
        IngressConfiguration:
          IsPubliclyAccessible: true
      ServiceName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - client-api
      SourceConfiguration:
        AuthenticationConfiguration:
          AccessRoleArn: !GetAtt 'AppRunnerEcrRole.Arn'
        AutoDeploymentsEnabled: false
        ImageRepository:
          ImageConfiguration:
            Port: '80'
            RuntimeEnvironmentVariables:
              - Name: APP_URL
                Value: !If
                  - HasContentApiUrl
                  - !Ref 'AppUrlContentApi'
                  - !GetAtt 'AppRunnerClientApiSvc.ServiceUrl'
              - Name: AWS_BUCKET
                Value: 'fora-stage-storage-bucket'
              - Name: BOOKING_SUPPLIER_HBSI_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_USERNAME}}'
              - Name: BOOKING_SUPPLIER_HBSI_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_PASSWORD}}'
              - Name: BOOKING_SUPPLIER_HBSI_CHANNEL_IDENTIFIER_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_CHANNEL_IDENTIFIER_ID}}'
              - Name: BOOKING_SUPPLIER_HBSI_SEARCH_BOOK_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_SEARCH_BOOK_URL}}'
              - Name: BOOKING_SUPPLIER_HBSI_TARGET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_TARGET}}'
              - Name: BOOKING_SUPPLIER_HBSI_COMPONENT_INFO_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_COMPONENT_INFO_ID}}'
              - Name: CACHE_DRIVER
                Value: 'file'
              - Name: CACHE_STORE
                Value: 'redis'
              - Name: SUPPLIER_EXPEDIA_API_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_API_KEY}}'
              - Name: SUPPLIER_EXPEDIA_SHARED_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_SHARED_SECRET}}'
              - Name: SUPPLIER_EXPEDIA_BASE_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_BASE_URL}}'
              - Name: SUPPLIER_ICE_PORTAL_CLIENT_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_CLIENT_ID}}'
              - Name: SUPPLIER_ICE_PORTAL_CLIENT_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_CLIENT_SECRET}}'
              - Name: SUPPLIER_ICE_PORTAL_BASE_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_BASE_URL}}'
              - Name: SUPPLIER_ICE_PORTAL_TOKEN_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_TOKEN_URL}}'
              - Name: GIATA_POI_BASE_URI
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_BASE_URI}}'
              - Name: GIATA_POI_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_USERNAME}}'
              - Name: GIATA_POI_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_PASSWORD}}'
              - Name: GIATA_MAIN_BASE_URI
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_BASE_URI}}'
              - Name: GIATA_MAIN_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_USERNAME}}'
              - Name: GIATA_MAIN_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_PASSWORD}}'
              - Name: HILTON_CLIENT_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:HILTON_CLIENT_ID}}'
              - Name: HILTON_CLIENT_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:HILTON_CLIENT_SECRET}}'
              - Name: GOOGLE_API_DEVELOPER_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GOOGLE_API_DEVELOPER_KEY}}'
              - Name: LOG_AWS_CLOUDWATCH_ACCESS_KEY_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:LOG_AWS_CLOUDWATCH_ACCESS_KEY_ID}}'
              - Name: LOG_AWS_CLOUDWATCH_SECRET_ACCESS_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:LOG_AWS_CLOUDWATCH_SECRET_ACCESS_KEY}}'
              - Name: LOG_CHANNEL
                Value: 'daily'
              - Name: DB_CONNECTION
                Value: 'mysql'
              - Name: DB_DATABASE
                Value: !Ref 'DbDatabase'
              - Name: DB_HOST
                Value: !GetAtt 'RdsMysql.Endpoint.Address'
              - Name: DB_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:password}}
              - Name: DB_PORT
                Value: '3306'
              - Name: DB_USERNAME
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:username}}
              - Name: RABBITMQ_HOST
                Value: !Join
                  - ''
                  - !Split
                    - :5671
                    - !Join
                      - ''
                      - !Split
                        - amqps://
                        - !Select
                          - 0
                          - !GetAtt 'RabbitMqBroker.AmqpEndpoints'
              - Name: RABBITMQ_LOGIN
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretMqCreds'
                    - :SecretString:username}}
              - Name: RABBITMQ_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretMqCreds'
                    - :SecretString:password}}
              - Name: RABBITMQ_PORT
                Value: '5671'
              - Name: REDIS_HOST
                Value: !GetAtt 'RedisCache.RedisEndpoint.Address'
              - Name: SUPPLIER_CONTENT_DB_DATABASE
                Value: !Ref 'DbSupplierContentDatabase'
              - Name: SUPPLIER_CONTENT_DB_HOST
                Value: !GetAtt 'RdsMysql.Endpoint.Address'
              - Name: SUPPLIER_CONTENT_DB_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:password}}
              - Name: SUPPLIER_CONTENT_DB_PORT
                Value: '3306'
              - Name: SUPPLIER_CONTENT_DB_USERNAME
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:username}}
              - Name: FILESYSTEM_DISK
                Value: s3
              - Name: PORT
                Value: '80'
          ImageIdentifier: !Join
            - ''
            - - !Ref 'AWS::AccountId'
              - .dkr.ecr.
              - !Ref 'AWS::Region'
              - .amazonaws.com/
              - !Ref 'APPNAME'
              - -api:latest
          ImageRepositoryType: ECR
    Type: AWS::AppRunner::Service
  AppRunnerEcrRole:
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - build.apprunner.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSAppRunnerServicePolicyForECRAccess
      RoleName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - apprunner-ecr-role
    Type: AWS::IAM::Role
  AppRunnerInstanceRole:
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - tasks.apprunner.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonElastiCacheFullAccess
        - arn:aws:iam::aws:policy/AmazonMQFullAccess
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - s3:ListBucket
                Effect: Allow
                Resource:
                  - !GetAtt 'S3StorageBucket.Arn'
                Sid: listBucket
              - Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                Effect: Allow
                Resource: !Join
                  - ''
                  - - !GetAtt 'S3StorageBucket.Arn'
                    - /*
                Sid: s3access
              - Action:
                  - secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  - !Join
                    - ':'
                    - - 'arn:aws:secretsmanager'
                      - !Ref 'AWS::Region'
                      - !Ref 'AWS::AccountId'
                      - 'secret:'
                      - !Join
                        - '-'
                        - - !Ref 'APPNAME'
                          - envs
                      - '*'
                Sid: SecretsManagerAccess
              - Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Effect: Allow
                Resource:
                  - arn:aws:logs:*:*:*
                Sid: CloudWatchLogsAccess
          PolicyName: s3-and-secrets-access
      RoleName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - apprunner-role
    Type: AWS::IAM::Role
  AppRunnerPricingApiSvc:
    DeletionPolicy: Delete
    Properties:
      AutoScalingConfigurationArn: !GetAtt 'AppRunnerAutoScalingConf.AutoScalingConfigurationArn'
      InstanceConfiguration:
        Cpu: 1 vCPU
        InstanceRoleArn: !GetAtt 'AppRunnerInstanceRole.Arn'
        Memory: 2 GB
      NetworkConfiguration:
        EgressConfiguration:
          EgressType: VPC
          VpcConnectorArn: !GetAtt 'AppRunnerVpcConnector.VpcConnectorArn'
        IngressConfiguration:
          IsPubliclyAccessible: true
      ServiceName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - pricing-api
      SourceConfiguration:
        AuthenticationConfiguration:
          AccessRoleArn: !GetAtt 'AppRunnerEcrRole.Arn'
        AutoDeploymentsEnabled: false
        ImageRepository:
          ImageConfiguration:
            Port: '80'
            RuntimeEnvironmentVariables:
              - Name: APP_URL
                Value: !If
                  - HasPricingApiUrl
                  - !Ref 'AppUrlPricingApi'
                  - !GetAtt 'AppRunnerPricingApiSvc.ServiceUrl'
              - Name: AWS_BUCKET
                Value: 'fora-stage-storage-bucket'
              - Name: BOOKING_SUPPLIER_HBSI_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_USERNAME}}'
              - Name: BOOKING_SUPPLIER_HBSI_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_PASSWORD}}'
              - Name: BOOKING_SUPPLIER_HBSI_CHANNEL_IDENTIFIER_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_CHANNEL_IDENTIFIER_ID}}'
              - Name: BOOKING_SUPPLIER_HBSI_SEARCH_BOOK_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_SEARCH_BOOK_URL}}'
              - Name: BOOKING_SUPPLIER_HBSI_TARGET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_TARGET}}'
              - Name: BOOKING_SUPPLIER_HBSI_COMPONENT_INFO_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:BOOKING_SUPPLIER_HBSI_COMPONENT_INFO_ID}}'
              - Name: CACHE_DRIVER
                Value: 'file'
              - Name: CACHE_STORE
                Value: 'redis'
              - Name: SUPPLIER_EXPEDIA_API_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_API_KEY}}'
              - Name: SUPPLIER_EXPEDIA_SHARED_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_SHARED_SECRET}}'
              - Name: SUPPLIER_EXPEDIA_BASE_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_EXPEDIA_BASE_URL}}'
              - Name: SUPPLIER_ICE_PORTAL_CLIENT_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_CLIENT_ID}}'
              - Name: SUPPLIER_ICE_PORTAL_CLIENT_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_CLIENT_SECRET}}'
              - Name: SUPPLIER_ICE_PORTAL_BASE_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_BASE_URL}}'
              - Name: SUPPLIER_ICE_PORTAL_TOKEN_URL
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:SUPPLIER_ICE_PORTAL_TOKEN_URL}}'
              - Name: GIATA_POI_BASE_URI
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_BASE_URI}}'
              - Name: GIATA_POI_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_USERNAME}}'
              - Name: GIATA_POI_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_POI_PASSWORD}}'
              - Name: GIATA_MAIN_BASE_URI
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_BASE_URI}}'
              - Name: GIATA_MAIN_USERNAME
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_USERNAME}}'
              - Name: GIATA_MAIN_PASSWORD
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GIATA_MAIN_PASSWORD}}'
              - Name: HILTON_CLIENT_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:HILTON_CLIENT_ID}}'
              - Name: HILTON_CLIENT_SECRET
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:HILTON_CLIENT_SECRET}}'
              - Name: GOOGLE_API_DEVELOPER_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:GOOGLE_API_DEVELOPER_KEY}}'
              - Name: LOG_AWS_CLOUDWATCH_ACCESS_KEY_ID
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:LOG_AWS_CLOUDWATCH_ACCESS_KEY_ID}}'
              - Name: LOG_AWS_CLOUDWATCH_SECRET_ACCESS_KEY
                Value: '{{resolve:secretsmanager:fora-stage-envs:SecretString:LOG_AWS_CLOUDWATCH_SECRET_ACCESS_KEY}}'
              - Name: LOG_CHANNEL
                Value: 'daily'
              - Name: DB_CONNECTION
                Value: 'mysql'
              - Name: DB_DATABASE
                Value: !Ref 'DbDatabase'
              - Name: DB_HOST
                Value: !GetAtt 'RdsMysql.Endpoint.Address'
              - Name: DB_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:password}}
              - Name: DB_PORT
                Value: '3306'
              - Name: DB_USERNAME
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:username}}
              - Name: RABBITMQ_HOST
                Value: !Join
                  - ''
                  - !Split
                    - :5671
                    - !Join
                      - ''
                      - !Split
                        - amqps://
                        - !Select
                          - 0
                          - !GetAtt 'RabbitMqBroker.AmqpEndpoints'
              - Name: RABBITMQ_LOGIN
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretMqCreds'
                    - :SecretString:username}}
              - Name: RABBITMQ_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretMqCreds'
                    - :SecretString:password}}
              - Name: RABBITMQ_PORT
                Value: '5671'
              - Name: REDIS_HOST
                Value: !GetAtt 'RedisCache.RedisEndpoint.Address'
              - Name: SUPPLIER_CONTENT_DB_DATABASE
                Value: !Ref 'DbSupplierContentDatabase'
              - Name: SUPPLIER_CONTENT_DB_HOST
                Value: !GetAtt 'RdsMysql.Endpoint.Address'
              - Name: SUPPLIER_CONTENT_DB_PASSWORD
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:password}}
              - Name: SUPPLIER_CONTENT_DB_PORT
                Value: '3306'
              - Name: SUPPLIER_CONTENT_DB_USERNAME
                Value: !Join
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - !Ref 'SecretRdsMasterCreds'
                    - :SecretString:username}}
              - Name: FILESYSTEM_DISK
                Value: s3
              - Name: PORT
                Value: '80'
          ImageIdentifier: !Join
            - ''
            - - !Ref 'AWS::AccountId'
              - .dkr.ecr.
              - !Ref 'AWS::Region'
              - .amazonaws.com/
              - !Ref 'APPNAME'
              - -api:latest
          ImageRepositoryType: ECR
    Type: AWS::AppRunner::Service
  AppRunnerVpcConnector:
    DeletionPolicy: Delete
    Properties:
      SecurityGroups:
        - !Ref 'AppRunerSecurityGroup'
      Subnets:
        - !Ref 'SubnetPrivate1'
      VpcConnectorName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - vpc-connector
    Type: AWS::AppRunner::VpcConnector
  CodeBuildBackend:
    DeletionPolicy: Delete
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      ConcurrentBuildLimit: '1'
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        PrivilegedMode: true
        Type: LINUX_CONTAINER
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
      Name: !Join
        - '-'
        - - !Ref 'APPNAME'
          - backend
      ServiceRole: !GetAtt 'CodeBuildBackendRole.Arn'
      Source:
        BuildSpec: !Join
          - "\n"
          - - 'version: 0.2'
            - ''
            - 'env:'
            - '  secrets-manager:'
            - '    DOCKERHUB_USERNAME: "/dockerhub/fora/creds:username"'
            - '    DOCKERHUB_PASS: "/dockerhub/fora/creds:password"'
            - '  parameter-store:'
            - !Join
              - ''
              - - '    SSH_KEY: "/ec2/keypair/'
                - !GetAtt 'EC2TasksKeyPair.KeyPairId'
                - '"'
            - '  variables:'
            - !Join
              - ''
              - - '    ECR_URL: '
                - !Ref 'AWS::AccountId'
                - .dkr.ecr.
                - !Ref 'AWS::Region'
                - .amazonaws.com
            - !Join
              - ''
              - - '    TASKS_EC2_IP: '
                - !GetAtt 'EC2Tasks.PrivateIp'
            - !Join
              - ''
              - - '    API_REPO_NAME: '
                - !Ref 'APPNAME'
                - -api
            - !Join
              - ''
              - - '    TASKS_REPO_NAME: '
                - !Ref 'APPNAME'
                - -tasks
            - ''
            - 'phases:'
            - '  pre_build:'
            - '    commands:'
            - '      - docker login --username $DOCKERHUB_USERNAME --password $DOCKERHUB_PASS'
            - !Join
              - ''
              - - '      - aws ecr get-login-password --region '
                - !Ref 'AWS::Region'
                - ' | docker login --username AWS --password-stdin ${ECR_URL}'
            - '  build:'
            - '    commands:'
            - '      - echo "Build Docker images"'
            - '      - docker build -t ${API_REPO_NAME} -f infrastructure/docker/php-8.2/Dockerfile .'
            - '      - docker tag ${API_REPO_NAME}:latest ${ECR_URL}/${API_REPO_NAME}:${CODEBUILD_RESOLVED_SOURCE_VERSION::7}'
            - '      - docker tag ${API_REPO_NAME}:latest ${ECR_URL}/${API_REPO_NAME}:latest'
            - '      - docker push ${ECR_URL}/${API_REPO_NAME}:latest'
            - '      - docker push ${ECR_URL}/${API_REPO_NAME}:${CODEBUILD_RESOLVED_SOURCE_VERSION::7}'
            - !Join
              - ''
              - - '      - aws apprunner start-deployment --service-arn '
                - !GetAtt 'AppRunnerPricingApiSvc.ServiceArn'
            - !Join
              - ''
              - - '      - aws apprunner start-deployment --service-arn '
                - !GetAtt 'AppRunnerBookingAdminApiSvc.ServiceArn'
            - !Join
              - ''
              - - '      - aws apprunner start-deployment --service-arn '
                - !GetAtt 'AppRunnerClientApiSvc.ServiceArn'
            - '      - docker build -t ${TASKS_REPO_NAME} -f infrastructure/docker/php-8.2/tasks.Dockerfile .'
            - '      - docker tag ${TASKS_REPO_NAME}:latest ${ECR_URL}/${TASKS_REPO_NAME}:${CODEBUILD_RESOLVED_SOURCE_VERSION::7}'
            - '      - docker tag ${TASKS_REPO_NAME}:latest ${ECR_URL}/${TASKS_REPO_NAME}:latest'
            - '      - docker push ${ECR_URL}/${TASKS_REPO_NAME}:latest'
            - '      - docker push ${ECR_URL}/${TASKS_REPO_NAME}:${CODEBUILD_RESOLVED_SOURCE_VERSION::7}'
            - '      - if [ $(echo $SSH_KEY | wc -l) -gt 1 ]; then echo $SSH_KEY > sshkey.pem; else echo $SSH_KEY | sed ''s/\(KEY----- \)/\1\n/'' | sed ''s/\(-----END\)/\n\1/'' > sshkey.pem; fi'
            - '      - chmod 400 sshkey.pem'
            - '      - ssh-keyscan $TASKS_EC2_IP >> ~/.ssh/known_hosts'
            - !Join
              - ''
              - - '      - ssh -i sshkey.pem ec2-user@$TASKS_EC2_IP "aws ecr get-login-password --region '
                - !Ref 'AWS::Region'
                - ' | docker login --username AWS --password-stdin ${ECR_URL}"'
            - '      - ssh -i sshkey.pem ec2-user@$TASKS_EC2_IP "docker pull ${ECR_URL}/${TASKS_REPO_NAME}:latest"'
            - !Join
              - ''
              - - '      - ssh -i sshkey.pem ec2-user@$TASKS_EC2_IP "docker rm -f '
                - !Ref 'APPNAME'
                - -tasks"
            - !Join
              - ''
              - - '      - ssh -i sshkey.pem ec2-user@$TASKS_EC2_IP "docker run --name='
                - !Ref 'APPNAME'
                - -tasks --log-driver=awslogs --log-opt awslogs-region=
                - !Ref 'AWS::Region'
                - ' --log-opt awslogs-group='
                - !Ref 'APPNAME'
                - -tasks --log-opt awslogs-create-group=true -d --env-file /home/ec2-user/.tasks.env ${ECR_URL}/${TASKS_REPO_NAME}:latest"
            - '      - ssh -i sshkey.pem ec2-user@$TASKS_EC2_IP "docker image prune -f"'
        Type: CODEPIPELINE
      Visibility: PRIVATE
      VpcConfig:
        SecurityGroupIds:
          - !Ref 'CodeBuildBackendSG'
        Subnets:
          - !Ref 'SubnetPrivate1'
        VpcId: !Ref 'VPC'
    Type: AWS::CodeBuild::Project
  CodeBuildBackendRole:
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  - !Ref 'SecretDockerHubCreds'
                  - !Join # Dynamically build secret name
                    - ':'
                    - - 'arn:aws:secretsmanager'
                      - !Ref 'AWS::Region'
                      - !Ref 'AWS::AccountId'
                      - 'secret:'
                      - !Join # Dynamically build secret name
                        - '-'
                        - - !Ref 'APPNAME'
                          - envs
                      - '*' # Wildcard for suffix
                Sid: secretsread
              - Action:
                  - ssm:GetParameters
                Effect: Allow
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:ssm:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :parameter/ec2/keypair/
                      - !GetAtt 'EC2TasksKeyPair.KeyPairId'
                Sid: parameterread
              - Action:
                  - apprunner:StartDeployment
                Effect: Allow
                Resource:
                  - '*'
                Sid: startapprunnerdeployment
              - Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
                Effect: Allow
                Resource:
                  - !Join
                    - ''
                    - - arn:aws:s3:::codepipeline-
                      - !Ref 'AWS::Region'
                      - -*
              - Action:
                  - codebuild:CreateReportGroup
                  - codebuild:CreateReport
                  - codebuild:UpdateGroup
                  - codebuild:BatchPutTestCases
                  - codebuild:BatchPutCodeCoverages
                Effect: Allow
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:codebuild:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :report-group/*
              - Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeSubnets
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeVpcs
                Effect: Allow
                Resource:
                  - '*'
              - Action:
                  - ec2:CreateNetworkInterfacePermission
                Condition:
                  StringEquals:
                    ec2:AuthorizedService: codebuild.amazonaws.com
                    ec2:Subnet:
                      - !Join
                        - ''
                        - - 'arn:aws:ec2:'
                          - !Ref 'AWS::Region'
                          - ':'
                          - !Ref 'AWS::AccountId'
                          - :subnet/
                          - !GetAtt 'SubnetPrivate1.SubnetId'
                Effect: Allow
                Resource: !Join
                  - ''
                  - - 'arn:aws:ec2:'
                    - !Ref 'AWS::Region'
                    - ':'
                    - !Ref 'AWS::AccountId'
                    - :network-interface/*
          PolicyName: CodeBuild-backend
      RoleName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - codebuild-backend
    Type: AWS::IAM::Role
  CodeBuildBackendSG:
    DeletionPolicy: Delete
    Properties:
      GroupDescription: CodeBuild backend SG
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  CodePipelineBackend:
    DeletionPolicy: Delete
    Properties:
      ArtifactStore:
        Location: !Ref 'S3CodePipelineBucket'
        Type: S3
      Name: !Join
        - '-'
        - - !Ref 'APPNAME'
          - backend
      PipelineType: V1
      RoleArn: !GetAtt 'CodePipelineFrontendRole.Arn'
      Stages:
        - Actions:
            - ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                BranchName: !Ref 'GitHubBackendBranch'
                ConnectionArn: !Ref 'GhConnectionArn'
                FullRepositoryId: !Ref 'GitHubBackendRepo'
                OutputArtifactFormat: CODE_ZIP
              Name: Source
              OutputArtifacts:
                - Name: SourceArtifact
              RunOrder: '1'
          Name: Source
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref 'CodeBuildBackend'
              InputArtifacts:
                - Name: SourceArtifact
              Name: Build
              RunOrder: '1'
          Name: Build
    Type: AWS::CodePipeline::Pipeline
  CodePipelineFrontendRole:
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - iam:PassRole
                Condition:
                  StringEqualsIfExists:
                    iam:PassedToService:
                      - cloudformation.amazonaws.com
                      - elasticbeanstalk.amazonaws.com
                      - ec2.amazonaws.com
                      - ecs-tasks.amazonaws.com
                Effect: Allow
                Resource: '*'
              - Action:
                  - codecommit:CancelUploadArchive
                  - codecommit:GetBranch
                  - codecommit:GetCommit
                  - codecommit:GetRepository
                  - codecommit:GetUploadArchiveStatus
                  - codecommit:UploadArchive
                Effect: Allow
                Resource: '*'
              - Action:
                  - codedeploy:CreateDeployment
                  - codedeploy:GetApplication
                  - codedeploy:GetApplicationRevision
                  - codedeploy:GetDeployment
                  - codedeploy:GetDeploymentConfig
                  - codedeploy:RegisterApplicationRevision
                Effect: Allow
                Resource: '*'
              - Action:
                  - codestar-connections:UseConnection
                Effect: Allow
                Resource: '*'
              - Action:
                  - elasticbeanstalk:*
                  - ec2:*
                  - elasticloadbalancing:*
                  - autoscaling:*
                  - cloudwatch:*
                  - s3:*
                  - sns:*
                  - cloudformation:*
                  - rds:*
                  - sqs:*
                  - ecs:*
                Effect: Allow
                Resource: '*'
              - Action:
                  - lambda:InvokeFunction
                  - lambda:ListFunctions
                Effect: Allow
                Resource: '*'
              - Action:
                  - opsworks:CreateDeployment
                  - opsworks:DescribeApps
                  - opsworks:DescribeCommands
                  - opsworks:DescribeDeployments
                  - opsworks:DescribeInstances
                  - opsworks:DescribeStacks
                  - opsworks:UpdateApp
                  - opsworks:UpdateStack
                Effect: Allow
                Resource: '*'
              - Action:
                  - cloudformation:CreateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:UpdateStack
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:SetStackPolicy
                  - cloudformation:ValidateTemplate
                Effect: Allow
                Resource: '*'
              - Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuildBatches
                  - codebuild:StartBuildBatch
                Effect: Allow
                Resource: '*'
              - Action:
                  - devicefarm:ListProjects
                  - devicefarm:ListDevicePools
                  - devicefarm:GetRun
                  - devicefarm:GetUpload
                  - devicefarm:CreateUpload
                  - devicefarm:ScheduleRun
                Effect: Allow
                Resource: '*'
              - Action:
                  - servicecatalog:ListProvisioningArtifacts
                  - servicecatalog:CreateProvisioningArtifact
                  - servicecatalog:DescribeProvisioningArtifact
                  - servicecatalog:DeleteProvisioningArtifact
                  - servicecatalog:UpdateProduct
                Effect: Allow
                Resource: '*'
              - Action:
                  - cloudformation:ValidateTemplate
                Effect: Allow
                Resource: '*'
              - Action:
                  - ecr:DescribeImages
                Effect: Allow
                Resource: '*'
              - Action:
                  - states:DescribeExecution
                  - states:DescribeStateMachine
                  - states:StartExecution
                Effect: Allow
                Resource: '*'
              - Action:
                  - appconfig:StartDeployment
                  - appconfig:StopDeployment
                  - appconfig:GetDeployment
                Effect: Allow
                Resource: '*'
            Version: '2012-10-17'
          PolicyName: CodeBuild-policy
      RoleName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - codepipeline-frontend
    Type: AWS::IAM::Role
  EC2TASKSROLE:
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonElastiCacheFullAccess
        - arn:aws:iam::aws:policy/AmazonMQFullAccess
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Effect: Allow
                Resource:
                  - arn:aws:logs:*:*:*
                Sid: CloudWatchAccess
          PolicyName: ec2-cloudwatch-policy
        - PolicyDocument:
            Statement:
              - Action:
                  - secretsmanager:GetResourcePolicy
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                  - secretsmanager:ListSecretVersionIds
                Effect: Allow
                Resource:
                  - arn:aws:secretsmanager:*:*:*
                Sid: SecretAccess
              - Action:
                  - secretsmanager:GetRandomPassword
                Effect: Allow
                Resource:
                  - '*'
                Sid: GetRandomPass
          PolicyName: secrets-read
        - PolicyDocument:
            Statement:
              - Action:
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - ecr:DescribeImages
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                Effect: Allow
                Resource:
                  - '*'
                Sid: ecraccess
          PolicyName: ecr-access
        - PolicyDocument:
            Statement:
              - Action:
                  - s3:ListBucket
                Effect: Allow
                Resource:
                  - !GetAtt 'S3StorageBucket.Arn'
                Sid: listBucket
              - Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                Effect: Allow
                Resource: !Join
                  - ''
                  - - !GetAtt 'S3StorageBucket.Arn'
                    - /*
                Sid: s3access
          PolicyName: s3-access
      RoleName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - ec2-tasks-role
    Type: AWS::IAM::Role
  EC2Tasks:
    Type: AWS::EC2::Instance
    DeletionPolicy: Delete
    Properties:
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            DeleteOnTermination: true
            VolumeSize: 60
            VolumeType: gp2
      IamInstanceProfile: !Ref 'TasksInstanceProfile'
      ImageId: !Ref LatestAmiId
      InstanceType: !Ref 'EC2TasksInstanceType'
      KeyName: !Ref 'EC2TasksKeyPair'
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeleteOnTermination: true
          DeviceIndex: '0'
          GroupSet:
            - !Ref 'EC2TasksSecurityGroup'
          SubnetId: !Ref 'SubnetPublic1'
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - tasks
        - Key: UserDataVersion
          Value: 202506131800
      UserData: !Base64
        'Fn::Join':
          - ''
          - # Start of bash script content
            - '#!/bin/bash -xe'
            - "\n"
            - 'pip3 install aws-secretsmanager-caching'
            - "\n"
            - |
              cat > /home/ec2-user/set_envs_from_secrets.py << 'EOF'
              import sys
              import os
              import json
              import botocore.session
              from aws_secretsmanager_caching import SecretCache, SecretCacheConfig

              def main():
                  # Expecting app_name and region only.
                  if len(sys.argv) < 3:
                      print("Usage: python script.py <app_name> <region>", file=sys.stderr)
                      sys.exit(1)

                  app_name = sys.argv[1]
                  region = sys.argv[2]

                  client = botocore.session.get_session().create_client("secretsmanager", region_name=region)
                  cache_config = SecretCacheConfig()
                  cache = SecretCache(config=cache_config, client=client)

                  # Initialize dictionary to store all collected variables
                  collected_env_vars = {}

                  # Fetch 'envs' credentials and add them to collected_env_vars
                  envs_secret_name = f"{app_name}-envs"
                  try:
                      secret_value = cache.get_secret_string(envs_secret_name)
                      secret_dict = json.loads(secret_value)
                      # Add all key-value pairs from the envs secret to the dictionary
                      collected_env_vars.update(secret_dict)
                      print(f"DEBUG: Successfully loaded secrets from: {envs_secret_name}", file=sys.stderr)
                  except Exception as e:
                      print(f"ERROR: Error loading secret {envs_secret_name}: {e}", file=sys.stderr)
                      sys.exit(1) # Consider if this is truly critical or if a fallback is possible

                  # Fetch RDS credentials and add them to collected_env_vars
                  rds_secret_name = f"{app_name}-rds-creds"
                  try:
                      rds_secret_value = cache.get_secret_string(rds_secret_name)
                      rds_secret = json.loads(rds_secret_value)
                      collected_env_vars.update({
                          "DB_HOST": rds_secret.get("host"),
                          "DB_PORT": str(rds_secret.get("port")),
                          "DB_USERNAME": rds_secret.get("username"),
                          "DB_PASSWORD": rds_secret.get("password"),
                          "SUPPLIER_CONTENT_DB_HOST": rds_secret.get("host"),
                          "SUPPLIER_CONTENT_DB_PORT": str(rds_secret.get("port")),
                          "SUPPLIER_CONTENT_DB_USERNAME": rds_secret.get("username"),
                          "SUPPLIER_CONTENT_DB_PASSWORD": rds_secret.get("password"),
                      })
                      print(f"DEBUG: Successfully loaded RDS secrets from: {rds_secret_name}", file=sys.stderr)
                  except Exception as e:
                      print(f"ERROR: Error loading RDS secret {rds_secret_name}: {e}", file=sys.stderr)
                      sys.exit(1)

                  # Fetch RabbitMQ credentials and add them to collected_env_vars
                  rabbitmq_secret_name = f"{app_name}-rabbitmq-creds"
                  try:
                      rabbitmq_secret_value = cache.get_secret_string(rabbitmq_secret_name)
                      rabbitmq_secret = json.loads(rabbitmq_secret_value)
                      collected_env_vars.update({
                          "RABBITMQ_USER": rabbitmq_secret.get("username"),
                          "RABBITMQ_PASSWORD": rabbitmq_secret.get("password"),
                      })
                      print(f"DEBUG: Successfully loaded RabbitMQ secrets from: {rabbitmq_secret_name}", file=sys.stderr)
                  except Exception as e:
                      print(f"ERROR: Error loading RabbitMQ secret {rabbitmq_secret_name}: {e}", file=sys.stderr)
                      sys.exit(1)

                  # Print all collected environment variables to stdout in KEY="VALUE" format
                  for key, value in collected_env_vars.items():
                      escaped_value = str(value).replace('"', '\\"') # Escape double quotes within values
                      sys.stdout.write(f'{key}="{escaped_value}"\n')

              if __name__ == "__main__":
                  main()
              EOF
            - "\n"
            - 'chmod 755 /home/ec2-user/set_envs_from_secrets.py'
            - "\n"
            - 'chown ec2-user:ec2-user /home/ec2-user/set_envs_from_secrets.py'
            - "\n"
            # Execute the Python script and capture its output into a temporary file
            - !Sub 'sudo -u ec2-user /usr/bin/python3 /home/ec2-user/set_envs_from_secrets.py ${APPNAME} ${AWS::Region} > /home/ec2-user/.secrets_from_python.env'
            - "\n"
            # Start building the .tasks.env file with static and dynamically derived variables
            - 'sudo -u ec2-user bash -c ''cat > /home/ec2-user/.tasks.env << "ALL_VARS_EOF"'
            - 'FILESYSTEM_DISK="s3"'
            - 'AWS_BUCKET="fora-stage-storage-bucket"' # Or derive this from !Ref 'S3StorageBucket'
            - !Sub 'AWS_DEFAULT_REGION="${AWS::Region}"' # Explicitly set default region
            - 'CACHE_DRIVER="redis"'
            - 'CACHE_STORE="redis"'
            - 'QUEUE_CONNECTION="rabbitmq"'
            - 'LOG_CHANNEL="cloudwatch"'
            - 'RABBITMQ_PORT="5671"'
            # Dynamically derive REDIS_HOST here
            - !Sub 'REDIS_HOST="${RedisCache.RedisEndpoint.Address}"'
            - 'REDIS_PORT="6379"'
            - 'ALL_VARS_EOF'''
            - "\n"
            # Append the RabbitMQ Host (dynamically derived from CloudFormation)
            # Create a shell variable 'RABBITMQ_ENDPOINT_VALUE' by directly resolving the CloudFormation intrinsic functions.
            # Then use that shell variable for string manipulation.
            - 'RABBITMQ_ENDPOINT_VALUE='
            - !Select [ 0, !GetAtt 'RabbitMqBroker.AmqpEndpoints' ]
            - "\n"
            - 'RABBITMQ_HOST=$(echo ${RABBITMQ_ENDPOINT_VALUE} | sed -e "s/^amqps:\\/\\///" -e "s/:5671$//")'
            - "\n"
            - 'sudo -u ec2-user bash -c "echo RABBITMQ_HOST=\\\"$RABBITMQ_HOST\\\" >> /home/ec2-user/.tasks.env"'
            - "\n"
            # Append the secrets fetched by the Python script to the .tasks.env file
            - 'sudo -u ec2-user cat /home/ec2-user/.secrets_from_python.env >> /home/ec2-user/.tasks.env'
            - "\n"
            - 'chown ec2-user:ec2-user /home/ec2-user/.tasks.env'
            - "\n"
            # Install and start Docker
            - 'sudo yum update -y'
            - 'sudo dnf install -y docker'
            - 'sudo usermod -a -G docker ec2-user'
            - 'sudo systemctl start docker'
            - 'sudo systemctl enable docker'
            - "\n"
            # Authenticate Docker with ECR
            - !Sub |
              aws ecr get-login-password --region ${AWS::Region} | docker login --username AWS --password-stdin ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com
            - "\n"
            # Run Docker container
            - !Sub |
              docker run --name=${APPNAME}-tasks --log-driver=awslogs --log-opt awslogs-region=${AWS::Region} --log-opt awslogs-group=${APPNAME}-tasks --log-opt awslogs-create-group=true -d --env-file /home/ec2-user/.tasks.env ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${APPNAME}-tasks:latest
            - "\n"
  EC2TasksKeyPair:
    DeletionPolicy: Delete
    Properties:
      KeyName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - tasks-key
    Type: AWS::EC2::KeyPair
  EC2TasksSecurityGroup:
    DeletionPolicy: Delete
    Properties:
      GroupDescription: Tasks instance SG
      SecurityGroupIngress:
        - FromPort: '22'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'CodeBuildBackendSG'
          ToPort: '22'
        - FromPort: '22'
          IpProtocol: tcp
          CidrIp: 217.119.69.6/32
          ToPort: '22'
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  EcrTasksRepo:
    DeletionPolicy: Delete
    Properties:
      ImageScanningConfiguration:
        ScanOnPush: false
      ImageTagMutability: MUTABLE
      RepositoryName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - tasks
    Type: AWS::ECR::Repository
  InternetGateway:
    DeletionPolicy: Delete
    Properties:
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - !Ref 'APPNAME'
              - igw
    Type: AWS::EC2::InternetGateway
  MQSecurityGroup:
    DeletionPolicy: Delete
    Properties:
      GroupDescription: Security group for MQ broker.
      SecurityGroupIngress:
        - FromPort: '5671'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'EC2TasksSecurityGroup'
          ToPort: '5671'
        - FromPort: '5671'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'AppRunerSecurityGroup'
          ToPort: '5671'
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  NatGw:
    DeletionPolicy: Delete
    DependsOn: VpcIgwAttachment
    Properties:
      AllocationId: !GetAtt 'NatGwEip.AllocationId'
      SubnetId: !Ref 'SubnetPublic1'
    Type: AWS::EC2::NatGateway
  NatGwEip:
    DeletionPolicy: Delete
    Properties:
      Domain: vpc
    Type: AWS::EC2::EIP
  PrivateRouteTableAssosiation:
    DeletionPolicy: Delete
    Properties:
      RouteTableId: !Ref 'RouteTablePrivate'
      SubnetId: !Ref 'SubnetPrivate1'
    Type: AWS::EC2::SubnetRouteTableAssociation
  PublicRouteTableAssosiation:
    DeletionPolicy: Delete
    Properties:
      RouteTableId: !Ref 'RouteTablePublic'
      SubnetId: !Ref 'SubnetPublic1'
    Type: AWS::EC2::SubnetRouteTableAssociation
  RabbitMqBroker:
    DeletionPolicy: Delete
    Properties:
      AutoMinorVersionUpgrade: true
      BrokerName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - rabbitmq
      DeploymentMode: SINGLE_INSTANCE
      EngineType: RABBITMQ
      EngineVersion: !Ref 'RabbitMqEngineVer'
      HostInstanceType: mq.t3.micro
      PubliclyAccessible: false
      SecurityGroups:
        - !Ref 'MQSecurityGroup'
      SubnetIds:
        - !Ref 'SubnetPrivateNoNat1'
      Users:
        - Password: !Join
            - ''
            - - '{{resolve:secretsmanager:'
              - !Ref 'SecretMqCreds'
              - :SecretString:password}}
          Username: !Join
            - ''
            - - '{{resolve:secretsmanager:'
              - !Ref 'SecretMqCreds'
              - :SecretString:username}}
    Type: AWS::AmazonMQ::Broker
  RdsMysql:
    DeletionPolicy: Delete
    Properties:
      AllocatedStorage: !Ref 'RdsDbAllocatedStorage'
      DBInstanceClass: !Ref 'RdsDbClass'
      DBInstanceIdentifier: !Join
        - '-'
        - - !Ref 'APPNAME'
          - mysql
      DBName: !Ref 'DbDatabase'
      DBSubnetGroupName: !Ref 'RdsSubnetGroup'
      Engine: mysql
      EngineVersion: 8.0.35
      MasterUserPassword: !Join
        - ''
        - - '{{resolve:secretsmanager:'
          - !Ref 'SecretRdsMasterCreds'
          - :SecretString:password}}
      MasterUsername: !Join
        - ''
        - - '{{resolve:secretsmanager:'
          - !Ref 'SecretRdsMasterCreds'
          - :SecretString:username}}
      VPCSecurityGroups:
        - !Ref 'RdsSecurityGroup'
    Type: AWS::RDS::DBInstance
  RdsSecurityGroup:
    DeletionPolicy: Delete
    Properties:
      GroupDescription: Security group for RDS DB Instance.
      SecurityGroupIngress:
        - FromPort: '3306'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'EC2TasksSecurityGroup'
          ToPort: '3306'
        - FromPort: '3306'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'AppRunerSecurityGroup'
          ToPort: '3306'
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  RdsSubnetGroup:
    DeletionPolicy: Delete
    Properties:
      DBSubnetGroupDescription: !Join
        - ' '
        - - SubnetGroup for
          - !Join
            - '-'
            - - !Ref 'APPNAME'
              - mysql
          - instance
      SubnetIds:
        - !Ref 'SubnetPrivateNoNat1'
        - !Ref 'SubnetPrivateNoNat2'
    Type: AWS::RDS::DBSubnetGroup
  RedisCache:
    DeletionPolicy: Delete
    Properties:
      AZMode: single-az
      CacheNodeType: cache.t4g.micro
      CacheSubnetGroupName: !Ref 'RedisSubnetGroup'
      ClusterName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - redis-cahe
      Engine: redis
      EngineVersion: '7.0'
      NumCacheNodes: '1'
      VpcSecurityGroupIds:
        - !Ref 'RedisSecurityGroup'
    Type: AWS::ElastiCache::CacheCluster
  RedisSecurityGroup:
    DeletionPolicy: Delete
    Properties:
      GroupDescription: Security group for Redis cache.
      SecurityGroupIngress:
        - FromPort: '6379'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'EC2TasksSecurityGroup'
          ToPort: '6379'
        - FromPort: '6379'
          IpProtocol: tcp
          SourceSecurityGroupId: !Ref 'AppRunerSecurityGroup'
          ToPort: '6379'
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::SecurityGroup
  RedisSubnetGroup:
    DeletionPolicy: Delete
    Properties:
      CacheSubnetGroupName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - redis-subnet-group
      Description: Subnger group for redis cache cluster
      SubnetIds:
        - !Ref 'SubnetPrivateNoNat1'
    Type: AWS::ElastiCache::SubnetGroup
  RouteInternetGw:
    DeletionPolicy: Delete
    Properties:
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref 'InternetGateway'
      RouteTableId: !Ref 'RouteTablePublic'
    Type: AWS::EC2::Route
  RouteNatGw:
    DeletionPolicy: Delete
    Properties:
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref 'NatGw'
      RouteTableId: !Ref 'RouteTablePrivate'
    Type: AWS::EC2::Route
  RouteTablePrivate:
    DeletionPolicy: Delete
    Properties:
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - private-route-table
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::RouteTable
  RouteTablePublic:
    DeletionPolicy: Delete
    Properties:
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - public-route-table
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::RouteTable
  S3CodePipelineBucket:
    DeletionPolicy: Delete
    Properties:
      AccessControl: Private
      BucketName: !Join
        - '-'
        - - codepipeline
          - !Ref 'AWS::Region'
          - !Ref 'AWS::AccountId'
    Type: AWS::S3::Bucket
  S3StorageBucket:
    DeletionPolicy: Delete
    Properties:
      AccessControl: Private
      BucketName: !Join
        - '-'
        - - !Ref 'APPNAME'
          - storage-bucket
    Type: AWS::S3::Bucket
  SecretDockerHubCreds:
    Properties:
      Name: /dockerhub/fora/creds
      SecretString: !Join
        - ''
        - - '{"username":"'
          - !Ref 'DockerHubUsername'
          - '",'
          - '"password":"'
          - !Ref 'DockerHubPassword'
          - '"}'
    Type: AWS::SecretsManager::Secret
  SecretMqCreds:
    DeletionPolicy: Delete
    Properties:
      Description: Credentials for RabbitMQ
      GenerateSecretString:
        ExcludePunctuation: true
        GenerateStringKey: password
        IncludeSpace: false
        PasswordLength: 30
        SecretStringTemplate: '{"username":"rabbitmq"}'
      Name: !Join
        - '-'
        - - !Ref 'APPNAME'
          - rabbitmq-creds
    Type: AWS::SecretsManager::Secret
  SecretRdsInstanceAttachment:
    DeletionPolicy: Delete
    Properties:
      SecretId: !Ref 'SecretRdsMasterCreds'
      TargetId: !Ref 'RdsMysql'
      TargetType: AWS::RDS::DBInstance
    Type: AWS::SecretsManager::SecretTargetAttachment
  SecretRdsMasterCreds:
    DeletionPolicy: Delete
    Properties:
      Description: RDS instance master password
      GenerateSecretString:
        ExcludePunctuation: true
        GenerateStringKey: password
        IncludeSpace: false
        PasswordLength: 30
        SecretStringTemplate: '{"username":"admin"}'
      Name: !Join
        - '-'
        - - !Ref 'APPNAME'
          - rds-creds
    Type: AWS::SecretsManager::Secret
  SubnetPrivate1:
    DeletionPolicy: Delete
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: AWS::Region
      CidrBlock: !Select
        - 0
        - !Cidr
          - !GetAtt 'VPC.CidrBlock'
          - 4
          - 8
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - private-subnet1
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::Subnet
  SubnetPrivateNoNat1:
    DeletionPolicy: Delete
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: AWS::Region
      CidrBlock: !Select
        - 1
        - !Cidr
          - !GetAtt 'VPC.CidrBlock'
          - 4
          - 8
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - private-no-nat-subnet1
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::Subnet
  SubnetPrivateNoNat2:
    DeletionPolicy: Delete
    Properties:
      AvailabilityZone: !Select
        - 1
        - !GetAZs
          Ref: AWS::Region
      CidrBlock: !Select
        - 2
        - !Cidr
          - !GetAtt 'VPC.CidrBlock'
          - 4
          - 8
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - private-no-nat-subnet2
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::Subnet
  SubnetPublic1:
    DeletionPolicy: Delete
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: AWS::Region
      CidrBlock: !Select
        - 3
        - !Cidr
          - !GetAtt 'VPC.CidrBlock'
          - 4
          - 8
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - public-subnet1
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::Subnet
  TasksInstanceProfile:
    DeletionPolicy: Delete
    Properties:
      Roles:
        - !Ref 'EC2TASKSROLE'
    Type: AWS::IAM::InstanceProfile
  VPC:
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !Ref 'VPCCIDR'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Application
          Value: !Ref 'AWS::StackName'
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'APPNAME'
              - vpc
    Type: AWS::EC2::VPC
  VpcIgwAttachment:
    DeletionPolicy: Delete
    Properties:
      InternetGatewayId: !Ref 'InternetGateway'
      VpcId: !Ref 'VPC'
    Type: AWS::EC2::VPCGatewayAttachment
